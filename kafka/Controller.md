# Controller
> ISR 리스트에서 리더 선출을 맡고 있는 브로커.

리더를 선출할 때 ISR 그룹 중에서 선출된다고 했습니다. 
카프카에서는 리더 선출을 담당하는 브로커가 하나 존재하며 이를 `컨트롤러`라 부릅니다.

ISR 리스트는 가용성을 위해 카프카에 저장되어 있으며, 컨트롤러는 브로커의 실패가 감지되면 즉시 ISR 리스트 중 하나를 새로운 파티션 리더로 선출합니다.


## 예기치 않은 장애로 인한 리더 선출 과정

1. A 브로커가 예기치 않게 다운됩니다.
2. 주키퍼는 A 브로커와 연결이 끊어진 후, 0번 파티션의 ISR에서 변화가 생겼음을 감지합니다.
3. **컨트롤러는 주키퍼 워치를 통해 0번 파티션에 변화가 생긴 것을 감지**하고, 파티션 ISR 중 새로운 리더를 선출합니다.
4. 컨트롤러는 새로운 리더의 정보를 주키퍼에 기록합니다.
5. 컨트롤러는 현재 활성화 상태인 모든 브로커에게 갱신된 정보를 전파합니다.

## 제어된 종료로 인한 리더 선출 과정
1. 관리자가 브로커 종료 명령어를 실행하고, SIG_TERM 신호가 브로커에게 전달됩니다.
2. **신호를 받은 브로커는 컨트롤러에게 알립니다.**
3. 컨트롤러는 리더 선출 작업을 실행하고, 해당 정보를 주키퍼에 기록합니다.
4. 컨트롤러는 갱신된 정보를 다른 브로커들에게 전파합니다.
5. **컨트롤러는 종료 요청을 보낸 브로커에게 정상 종료한다는 응답**을 보냅니다.
6. 응답을 받은 브로커는 **캐시에 있는 내용을 디스크에 저장하고 종료**합니다.

## 리더 선출 다운 타임
> 리더를 선출 하는 동안은 클라이언트인 프로듀서나 컨슈머가 메시지를 읽고 쓸 수 없습니다.

리카프카 `1.0.0`에서는 리더 선출 과정이 꽤 무거웠습니다. 
브로커가 다운되었을 때 리더를 선출해야하는 파티션의 개수에 비례해서 처리 시간이 증가했습니다.

리더가 선출되지 않으면 클라이언트가 메시지를 읽고 쓸 수 없기 때문에 실시간 데이터를 처리하는 부서들은 모두 장애 상황을 겪게 될 것입니다.

카프카 버전 `1.1.0`에서는 불필요한 로깅을 없애고 주키퍼 비동기 API를 반영하여 6분 30초 소요되던 작업이 3초만에 완료되도록 성능을 개선했습니다.


## 제어된 종료의 장점

- 다운 타임 최소화
  - `제어된 종료`를 하면 카프카 내부적으로 **파티션들의 다운 타임을 최소화** 할 수 있습니다.
  - 순차적으로 하나의 파티션마다 리더를 선출하게 되므로 각 파티션들은 다운타임을 최소화 하게 됩니다.
- 짧은 로그 복구 시간
  - 브로커는 종료 전에 자신의 모든 로그를 디스크에 동기화한 후에 종료되므로, 재시작 시 로그 복구 시간이 짧습니다.

이런 장점이 있는 제어된 종료를 사용하려면 `server.properties`에 `controllered.shutdown.enable = true` 설정이 적용되어야 합니다.